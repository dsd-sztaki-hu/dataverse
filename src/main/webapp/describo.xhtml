<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:jsf="http://xmlns.jcp.org/jsf"
      xmlns:pt="http://java.sun.com/jsf/passthrough"
      xmlns:cc="http://java.sun.com/jsf/composite"
      xmlns:o="http://omnifaces.org/ui"
      xmlns:iqbs="http://xmlns.jcp.org/jsf/composite/iqbs">
    <h:head>
    </h:head>

    <h:body>
        <ui:composition>
            <script>
                // TODO: pass apikey and user info on the fly
                async function openDescriboOnline() {
                    try {
                        let sessionId;
                        const persistentId = "#{persistentId}"
                        const folder = persistentId.substring(persistentId.indexOf('/'));
                        const folderPath = "/" + "#{DatasetPage.dataset.owner.displayName}" + folder
                        let response = await fetch("#{describoHost}" + "/api/session/application", {
                            method: "POST",
                            headers: {
                                Authorization: "Bearer " + "#{describoSecret}",
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                email: "john@email.com",
                                name: "John Citizen",
                                service: {
                                    dataverse: {
                                        "host": "#{dvHost}",
                                        "rootDataverse": "#{dvRoot}",
                                        "apiKey": "#{dvApiKey}",
                                        "dvPersistentId": persistentId,
                                        "folder": folderPath,
                                    },
                                },
                                /*configuration: {
                                     allowProfileChange: false,
                                     allowServiceChange: false,
                                 },
                                profile: {
                                     file: "ncbi-profile.json",
                                 },*/
                            }),
                        });
                        ({ sessionId } = await response.json());
                        document.getElementById('iframeId').src = "#{describoHost}" + "/application?sid=" + sessionId;
                    } catch (error) {
                        console.log("Error: " + error);
                    }
                }

            </script>
            <h2>Describo Online</h2>
            <button type="button" onclick="openDescriboOnline()">Describo Online</button>
            <div id="frame-div" class="embed-responsive embed-responsive-16by9">
                <iframe id="iframeId" title="Describo Online" src=""></iframe>
            </div>
        </ui:composition>
    </h:body>

</html>
